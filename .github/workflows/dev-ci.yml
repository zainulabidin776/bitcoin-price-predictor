name: Development CI Pipeline

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - dev

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 bandit safety
      
      - name: Lint with Flake8
        continue-on-error: true
        run: |
          echo "Running Flake8 linting..."
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
      
      - name: Security scan with Bandit
        continue-on-error: true
        run: |
          echo "Running Bandit security scan..."
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ || true
      
      - name: Check dependencies with Safety
        continue-on-error: true
        run: |
          echo "Checking dependencies for known vulnerabilities..."
          safety check --json || true
          safety check || true
      
      - name: Code quality summary
        run: |
          echo "::notice::✅ Code quality checks completed"
          echo "::notice::Review any warnings above"

  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Create test directories
        run: |
          mkdir -p data/raw data/processed models reports
      
      - name: Run unit tests
        continue-on-error: true
        run: |
          echo "Running unit tests..."
          # If tests directory exists, run tests
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=src --cov-report=term-missing || true
          else
            echo "No tests directory found. Skipping unit tests."
            echo "::notice::No unit tests configured yet"
          fi
      
      - name: Test summary
        run: |
          echo "::notice::✅ Unit tests completed"

  summary:
    runs-on: ubuntu-latest
    name: CI Summary
    needs: [code-quality, unit-tests]
    if: always()
    
    steps:
      - name: Report status
        run: |
          echo "Code Quality Result: ${{ needs.code-quality.result }}"
          echo "Unit Tests Result: ${{ needs.unit-tests.result }}"
          
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
            echo "::notice::✅ All development CI checks passed!"
          else
            echo "::warning::⚠️ Some checks had warnings. Review the logs above."
          fi

