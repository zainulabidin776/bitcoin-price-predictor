name: Production CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build Docker Image and Deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow python-dotenv
      
      - name: Get latest model from MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          echo "Fetching latest production model from MLflow..."
          python << PYTHON
          import mlflow
          import os
          
          # Connect to MLflow
          mlflow.set_tracking_uri(os.getenv('MLFLOW_TRACKING_URI'))
          
          # Get latest production model
          model_name = "crypto-volatility-predictor"
          
          try:
              client = mlflow.tracking.MlflowClient()
              latest_versions = client.get_latest_versions(model_name, stages=["Production"])
              
              if latest_versions:
                  print(f"âœ“ Found production model version: {latest_versions[0].version}")
                  with open("model_version.txt", "w") as f:
                      f.write(latest_versions[0].version)
              else:
                  print("No production model found, using latest")
                  with open("model_version.txt", "w") as f:
                      f.write("latest")
          except Exception as e:
              print(f"Error fetching model: {e}")
              with open("model_version.txt", "w") as f:
                  f.write("latest")
          PYTHON
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Generate version tag
        id: version
        run: |
          VERSION=$(cat model_version.txt)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create semantic version tag
          TAG="v${VERSION}-${SHORT_SHA}"
          
          echo "version_tag=$TAG" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Docker image will be tagged as: $TAG"
      
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
            ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/crypto-predictor:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/crypto-predictor:buildcache,mode=max
      
      - name: Test Docker image
        run: |
          echo "Testing Docker image..."
          
          # Run container in background
          docker run -d --name test-api \
            -p 8000:8000 \
            -e MODEL_NAME=crypto-volatility-predictor \
            -e MODEL_STAGE=Production \
            ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
          
          # Wait for container to start
          sleep 10
          
          # Test health endpoint
          echo "Testing health endpoint..."
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
          
          if [ "$HEALTH_STATUS" -eq 200 ]; then
            echo "âœ“ Health check passed"
          else
            echo "âœ— Health check failed with status: $HEALTH_STATUS"
            docker logs test-api
            exit 1
          fi
          
          # Test root endpoint
          echo "Testing root endpoint..."
          curl -f http://localhost:8000/ || (echo "Root endpoint failed" && exit 1)
          
          # Stop container
          docker stop test-api
          docker rm test-api
          
          echo "âœ“ All Docker image tests passed"
      
      - name: Push Docker image to registry
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
            ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/crypto-predictor:buildcache
      
      - name: Create deployment manifest
        run: |
          cat << EOF > deployment-manifest.yaml
          ---
          apiVersion: v1
          kind: DeploymentManifest
          metadata:
            name: crypto-predictor-deployment
            version: ${{ steps.version.outputs.version_tag }}
            timestamp: ${{ steps.version.outputs.timestamp }}
            commit: ${{ github.sha }}
          
          spec:
            image: ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
            replicas: 2
            resources:
              limits:
                cpu: "2"
                memory: "4Gi"
              requests:
                cpu: "1"
                memory: "2Gi"
            environment:
              - name: MODEL_NAME
                value: crypto-volatility-predictor
              - name: MODEL_STAGE
                value: Production
            healthCheck:
              path: /health
              port: 8000
              initialDelaySeconds: 30
              periodSeconds: 10
          EOF
          
          echo "Deployment manifest created"
          cat deployment-manifest.yaml
      
      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-artifacts
          path: |
            deployment-manifest.yaml
            model_version.txt
      
      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          release_name: Release ${{ steps.version.outputs.version_tag }}
          body: |
            ## ðŸš€ Production Deployment
            
            **Model Version**: ${{ steps.version.outputs.version_tag }}
            **Docker Image**: `${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}`
            **Commit**: ${{ github.sha }}
            **Timestamp**: ${{ steps.version.outputs.timestamp }}
            
            ### Deployment Instructions
            
            ```bash
            # Pull the image
            docker pull ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
            
            # Run container
            docker run -d -p 8000:8000 \
              -e MLFLOW_TRACKING_URI=<your-uri> \
              -e MODEL_NAME=crypto-volatility-predictor \
              -e MODEL_STAGE=Production \
              ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
            
            # Verify health
            curl http://localhost:8000/health
            ```
            
            ### Testing
            
            ```bash
            # Test prediction
            curl -X POST http://localhost:8000/predict \
              -H "Content-Type: application/json" \
              -d '{"features": [...]}'
            ```
          draft: false
          prerelease: false
      
      - name: Deployment summary
        run: |
          echo "::notice::âœ… Deployment completed successfully!"
          echo "::notice::Docker image: ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}"
          echo "::notice::Image also tagged as 'latest'"
          
          cat << EOF
          
          ================================================
          ðŸŽ‰ PRODUCTION DEPLOYMENT SUCCESSFUL
          ================================================
          
          Image: ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
          Commit: ${{ github.sha }}
          Timestamp: ${{ steps.version.outputs.timestamp }}
          
          To deploy:
          docker pull ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
          docker run -d -p 8000:8000 ${{ secrets.DOCKER_USERNAME }}/crypto-predictor:${{ steps.version.outputs.version_tag }}
          
          ================================================
          EOF

  notify:
    runs-on: ubuntu-latest
    name: Deployment Notification
    needs: [build-and-deploy]
    if: always()
    
    steps:
      - name: Send notification
        run: |
          if [[ "${{ needs.build-and-deploy.result }}" == "success" ]]; then
            echo "::notice::âœ… Production deployment successful!"
          else
            echo "::error::âŒ Production deployment failed!"
            exit 1
          fi